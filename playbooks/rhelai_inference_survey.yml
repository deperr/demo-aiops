---
- name: Send API request and debug complete response
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../vault.yml

  vars:
    inference_system_prompt: |
      You are a Department of Defense systems engineer who is applying STIG's to RHEL hosts.
      If violations are identifed, please recommend remediations.
      1. **Problem Identification:** Highlight the problem
      2. **Manual Remediation:** Suggest manual remediations
    inference_response_playbook: |
      You are a Department of Defense systems engineer who is applying STIG's to RHEL hosts.
      Create a playbook named "Re-baseline protected configuration files"
      Playbooks should be formatted using fully qualified content names (FQCN) for example ansible.builtin.file.
      If violations are identifed, please recommend remediations.
      1. **Automated Remediation:** Suggest Ansible playbook to reconfigure based on manual remediations. 
    log_output: |
      Ã— httpd.service - The Apache HTTP Server
           Loaded: loaded (/usr/lib/systemd/system/httpd.service; disabled; preset: disabled)
           Active: failed (Result: exit-code) since Tue 2025-04-08 15:56:15 UTC; 1h 11min ago
         Duration: 1min 9.506s
             Docs: man:httpd.service(8)
          Process: 4099 ExecStart=/usr/sbin/httpd $OPTIONS -DFOREGROUND (code=exited, status=1/FAILURE)
         Main PID: 4099 (code=exited, status=1/FAILURE)
           Status: "Reading configuration..."
              CPU: 58ms
     
      Apr 08 15:56:15 node1.example.com systemd[1]: Starting The Apache HTTP Server...
      Apr 08 15:56:15 node1.example.com httpd[4099]: AH00526: Syntax error on line 35 of /etc/httpd/conf/httpd.conf:
      Apr 08 15:56:15 node1.example.com httpd[4099]: Invalid command 'InvalidDirectiveHere', perhaps misspelled or defined by a module not included in the server configuration
      Apr 08 15:56:15 node1.example.com systemd[1]: httpd.service: Main process exited, code=exited, status=1/FAILURE
      Apr 08 15:56:15 node1.example.com systemd[1]: httpd.service: Failed with result 'exit-code'.
      Apr 08 15:56:15 node1.example.com systemd[1]: Failed to start The Apache HTTP Server.

  tasks:
    - name: Send POST request using uri module
      ansible.builtin.uri:
        url: "http://{{rag_endpoint}}:8000/stig-logs?logs={{ log_output | urlencode }}"
        method: POST
        headers:
          accept: "application/json"
        body: ""
        body_format: raw
        return_content: true
        status_code: 200
        timeout: 60
      register: rag_response

    - name: Combine output and set fact
      ansible.builtin.set_fact:
        final_prompt: |

          RAG Context:
          {{ rag_response }}

          Log output:
          {{ log_output }}

    - name: Send RCA prompt to RHEL AI (Root Cause Analysis)
      ansible.builtin.uri:
        url: https://{{ inference_endpoint }}:443/v1/chat/completions
        method: POST
        headers:
          accept: "application/json"
          Content-Type: "application/json"
          Authorization: "Bearer {{ token }}"
        body:
          model: granite-3-3-8b-instruct
          messages:
            - role: "system"
              content: "{{ inference_system_prompt }}"
            - role: "user"
              content: "{{ final_prompt }}"
        body_format: json
        return_content: true
        status_code: 200
        timeout: 120
      register: response_guide

    - name: Send RCA prompt to RHEL AI (Root Cause Analysis)
      ansible.builtin.uri:
        url: https://{{ inference_endpoint }}:443/v1/chat/completions
        method: POST
        headers:
          accept: "application/json"
          Content-Type: "application/json"
          Authorization: "Bearer {{ token }}"
        body:
          model: granite-3-3-8b-instruct
          messages:
            - role: "system"
              content: "{{ inference_response_playbook }}"
            - role: "user"
              content: "{{ final_prompt }}"
        body_format: json
        return_content: true
        status_code: 200
        timeout: 120
      register: response_playbook

    - name: Show the API response (initial help)
      ansible.builtin.debug:
        msg: "{{ response_guide.json }}"

    - name: Show the API response (playbook)
      ansible.builtin.debug:
        msg: "{{ response_playbook.json }}"
